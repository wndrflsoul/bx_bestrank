<? namespace Bitrix\Main\Security\W;$GLOBALS['____879213633']= array(base64_decode('dGltZ'.'Q='.'='),base64_decode('dGl'.'tZQ='.'='),base64_decode(''.'anNvbl'.'9kZW'.'NvZGU='),base64_decode(''.'Y'.'XJy'.'YXlfbWVyZ2U='),base64_decode('a'.'m9pbg=='),base64_decode('am9'.'pbg=='),base64_decode('a'.'m'.'9'.'pbg=='),base64_decode('YXJ'.'yYXlfcG'.'9'.'w'),base64_decode('YX'.'J'.'yYXlfc2hpZn'.'Q='),base64_decode('Y'.'XJyYXlfc2hpZn'.'Q='),base64_decode('YXJyYXl'.'fc'.'2hp'.'Z'.'nQ='),base64_decode('YXJyYXlfc2hpZn'.'Q='),base64_decode(''.'YX'.'JyY'.'XlfbW'.'V'.'yZ2U='),base64_decode('aX'.'Nf'.'YXJ'.'y'.'YXk'.'='),base64_decode('YXJyY'.'Xlf'.'bWVyZ2U'.'='),base64_decode('aW5fY'.'XJ'.'y'.'YXk='),base64_decode('aW'.'5fYXJyYXk='),base64_decode('aW'.'5f'.'YX'.'JyY'.'X'.'k='),base64_decode('aW5fYX'.'JyY'.'X'.'k='),base64_decode('aW5'.'fYXJy'.'Y'.'Xk='),base64_decode('d'.'Glt'.'ZQ=='),base64_decode(''.'dGltZQ=='),base64_decode('YXJyYXlf'.'b'.'WF'.'w'),base64_decode(''.'Z2V0X'.'2xvY'.'WRlZF'.'9'.'le'.'H'.'R'.'lbnNpb25z'),base64_decode('anNvbl'.'9lbm'.'Nv'.'ZGU='),base64_decode(''.'anNvb'.'l9'.'lb'.'m'.'N'.'vZGU'.'='),base64_decode('c'.'GhwdmVyc2lvbg=='),base64_decode(''.'a'.'nNvb'.'l9'.'lbm'.'Nv'.'ZGU='),base64_decode('am'.'9p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___853203826')){function ___853203826($_261594317){static $_346313426= false; if($_346313426 == false) $_346313426=array('V'.'1dB'.'TEx'.'fTE9DSw='.'=','c2'.'VjdX'.'J'.'pdHk=','REFUQQ==','e'.'yI=','V1dBTE'.'x'.'fTE9DS'.'w==','c'.'2Vj'.'dXJ'.'pdHk=','U0V'.'DVV'.'J'.'JVFlfV1dBTExfRV'.'hDRVBUSU'.'9O','Rk'.'FJTF'.'9'.'DSEVD'.'S'.'0'.'lORw==','Q2FuIG5'.'v'.'dC'.'BleGV'.'j'.'d'.'XRlI'.'Hd3YWx'.'sIHJ1'.'bGVzOiA=','IFRy'.'YWNlOi'.'A=','UkVRVU'.'VTV'.'F9VUk'.'k=','a2V5cw==','dmFsdW'.'V'.'z',''.'U0VDVVJJV'.'Fl'.'fV1dBTExfTU9ES'.'UZZ',''.'Lg==','U'.'0VDVVJJ'.'VFlfV1dB'.'TEx'.'fV'.'U5TR'.'VQ'.'=','Lg==',''.'U0VDVV'.'JJV'.'FlfV1dB'.'TExf'.'R'.'VhJV'.'A==','Lg==','Z2xvY'.'mFs','a2V5cw==','dmF'.'sdWV'.'z',''.'Z2'.'V'.'0','Z2V0','cG9'.'zdA==','cG9zdA==','Y29va'.'2l'.'l','Y29'.'va2l'.'l',''.'cmVxdWVzdA==','cmVxdWVzdA==','Z2xvYmFs','Z2'.'xvYmF'.'s','bWFpbl'.'9z'.'ZWM'.'=','V'.'1d'.'BT'.'E'.'xfQUNUV'.'UFMSVpFX1JVTEVT','dg==','dmVyc2lvbg'.'==','aQ==','aXNJbnN'.'0Y'.'WxsZ'.'WQ=','dg==','a'.'W5p','bW9k'.'dWxlcw'.'==','bGljZ'.'W5'.'z'.'ZQ==','cGhw','dg='.'=',''.'Z'.'Xh0','c2VjdX'.'JpdHk=','ZGI=','d'.'HlwZQ==','ZGI=','dmVyc2'.'lvbg==','ZGI=','dHl'.'wZQ==',''.'ZG'.'I=','d'.'Hlw'.'ZQ==','dm'.'V'.'yc2l'.'vbg='.'=','ZGI=','dmVyc2lv'.'bg==','ZW52aX'.'Jvb'.'m1lb'.'n'.'Q'.'=','dm1fdmVy'.'c2'.'lvbg==',''.'dm0=','dg'.'='.'=','ZW5'.'2aXJvb'.'m1lbnQ=','dm'.'1fdm'.'Vy'.'c2l'.'v'.'bg==',''.'c2'.'9j'.'a2V0'.'VGltZ'.'W91dA='.'=','c3R'.'yZ'.'WFtVG'.'ltZ'.'W91'.'dA==','K'.'Cc=',''.'ZGF'.'0Y'.'Q'.'==','Jywg'.'Jw'.'==','bW9'.'kdWxl','JywgJw'.'='.'=','b'.'W9kdWx'.'l'.'X3ZlcnNpb24=','J'.'yk=','L'.'CA=','U0VDVVJJ'.'V'.'Flf'.'V1'.'dBTExfRVhDRVBUS'.'U9O','b'.'WFpbg='.'=',''.'Rk'.'FJ'.'TF9'.'SRUZSRVNI'.'SU5H','Q2Fu'.'IG'.'5v'.'dC'.'ByZWZyZXNoIHd3YWxsIHJ'.'1bGV'.'zOi'.'A=','IFRyYWNlOiA=',''.'ZG'.'F0YQ'.'==',''.'eyI=','LS'.'0tLS1C'.'RU'.'dJTiBQV'.'UJM'.'S'.'UMgS0VZL'.'S0tLS0=','C'.'k1JSUJJa'.'kFOQm'.'drc'.'W'.'hraUc5dzBCQVFFR'.'kFB'.'T0NB'.'UT'.'hBTUlJQkNnS0NB'.'U'.'UV'.'BcThRRTB'.'I'.'am1IS'.'lVTd'.'FdW'.'Nm4wemE'.'K'.'UlZvTHgwMkt6YmZ'.'yYlMv'.'UD'.'Zz'.'V2F'.'4'.'VHp3OF'.'NlR'.'1R0YlRDT3JwS'.'Gk1'.'U'.'UY2T'.'1J5a'.'lov'.'WHh'.'6L0t'.'MV'.'TFH'.'Ym9mOUN'.'aMwo'.'0ejdTa3FVdDY'.'2aWJYdk9GQng0Zn'.'cv'.'QVBQ'.'UkdEcXR'.'tMG5EM2ZnR'.'3N1'.'M1J'.'l'.'UGd'.'3MjlpOCt'.'2bTdtdEJLSl'.'VZbDR'.'y'.'ClZwYj'.'Z'.'z'.'ZlpFVDlLRW'.'I'.'2VDF'.'IRFltRXZjMW'.'hxL2lp'.'dXl4T'.'HJaWmk1U'.'T'.'Z'.'VZ'.'mY0VUV2V'.'EkrNjh'.'zc0'.'ZSa1Erb'.'3d'.'UUnkKZU9JTWJG'.'aE0vVVRtZlZZY'.'lR'.'SRnkyb1VR'.'OFdN'.'e'.'m'.'E'.'ybko1U2Fo'.'emkxVUt'.'PMWpBalhUUFJye'.'mM3QWp1'.'Nj'.'M5ajFPMApwcHF'.'m'.'bTV4Z1d'.'sRkFK'.'a0h'.'RV'.'Gd'.'iZGQ1QVd'.'xREZ'.'Ra3'.'Q5SEtrWStUbmZ'.'CTEdWT'.'XZ'.'W'.'e'.'VB3VEhOV1FZQXc0eHB'.'nL'.'3dBClp3SURBUUF'.'CCi0tLS0tRU5E'.'IFBVQkxJQ'.'yBLRV'.'kt'.'LS0tLQ==');return base64_decode($_346313426[$_261594317]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1004216642= 'https://wwall.bitrix.info/rules.php'; protected $_1370633507= true; public function handle(){ try{  $_1712560504= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1712560504)){ return;}  $_1477862170= Cache::createInstance(); $_2012361900= false; if($_1477862170->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1434259338= $_1477862170->getVars(); if($GLOBALS['____879213633'][0]()- $_1434259338> round(0+5+5+5+5)){  $_178324251= Application::getConnection(); $_1435602000= RuleRecordTable::getTableName(); $_178324251->truncateTable($_1435602000); RuleRecordTable::cleanCache(); $_1477862170->clean(___853203826(0), ___853203826(1));}} elseif($_1477862170->startDataCache()){  $_1477862170->endDataCache($GLOBALS['____879213633'][1]()); $_2012361900= true;} foreach($_1712560504 as $_2034945499){ $_2115885437= new PublicKeyCipher; $_167836718= $_2115885437->decrypt($_2034945499[___853203826(2)], static::__2117506563()); if(!str_starts_with($_167836718, ___853203826(3))){ continue;} $_876893325= $GLOBALS['____879213633'][2]($_167836718, true); if(!empty($_876893325)){ $_1705850340= Rule::make($_876893325); $_971661303= $this->handleRule($_1705850340); $this->applyHandlingResults($_971661303);}}  if($_2012361900){ $_1477862170->clean(___853203826(4), ___853203826(5));}} catch(\Throwable $_1807518836){ $this->logEvent( ___853203826(6), ___853203826(7), ___853203826(8). $_1807518836->getMessage(). ___853203826(9). $_1807518836->getTraceAsString());}}  public function handleRule(Rule $_1705850340): array{ $_971661303=[]; if($_1705850340->matchPath($_SERVER[___853203826(10)])){  $_1413679776= $this->getContextElements($_1705850340->getContext()); foreach($_1413679776 as $_1374032640 => &$_1857551742){ $_971661303= $GLOBALS['____879213633'][3]($_971661303, $this->recursiveContextKeyHandle($_1374032640, $_1857551742,[], $_1705850340));}} return $_971661303;}  public function applyHandlingResults(array $_971661303){ $_1413679776= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_971661303 as $_1630729536){ $_1857551742=& $_1413679776[$_1630729536->getContextName()]; $_1033280096= $_1630729536->getRuleResult(); $_1705850340= $_1630729536->getRule(); if($_1033280096 instanceof ModifyResult){ if($_1705850340->getProcess() === ___853203826(11)){  static::rewriteContextKey( $_1630729536->getContextName(), $_1857551742, $_1630729536->getContextKey(), $_1033280096->getCleanValue());} elseif($_1705850340->getProcess() === ___853203826(12)){ static::rewriteContextValue( $_1630729536->getContextName(), $_1857551742, $_1630729536->getContextKey(), $_1033280096->getCleanValue());} $this->logEvent( ___853203826(13), $_1630729536->getContextName(), $GLOBALS['____879213633'][4](___853203826(14), $_1630729536->getContextKey()));} elseif($_1033280096 instanceof CheckResult &&!$_1033280096->isSuccess()){ if($_1033280096->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1630729536->getContextName(), $_1857551742, $_1630729536->getContextKey(),); $this->logEvent( ___853203826(15), $_1630729536->getContextName(), $GLOBALS['____879213633'][5](___853203826(16), $_1630729536->getContextKey()));} elseif($_1033280096->getAction() === RuleAction::EXIT){ $this->logEvent( ___853203826(17), $_1630729536->getContextName(), $GLOBALS['____879213633'][6](___853203826(18), $_1630729536->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1370633507= false;} protected function rewriteContextKey($_1374032640, &$_1857551742, $_1871031501, $_359561396){ $_254980714= $_1871031501;  $GLOBALS['____879213633'][7]($_254980714); $_254980714[]= $_359561396; if($_1374032640 === ___853203826(19)){ $_463175313= $GLOBALS['____879213633'][8]($_1871031501); $GLOBALS['____879213633'][9]($_254980714); if(empty($_1871031501)){ $GLOBALS[$_359561396]= $GLOBALS[$_463175313]; unset($GLOBALS[$_463175313]);} else{ $_1857551742=& $GLOBALS[$_463175313]; $_1416308937= ArrayHelper::getByNestedKey($_1857551742, $_1871031501);  ArrayHelper::setByNestedKey($_1857551742, $_254980714, $_1416308937);  ArrayHelper::unsetByNestedKey($_1857551742, $_1871031501);}} else{ $_1416308937= ArrayHelper::getByNestedKey($_1857551742, $_1871031501);  ArrayHelper::setByNestedKey($_1857551742, $_254980714, $_1416308937);  ArrayHelper::unsetByNestedKey($_1857551742, $_1871031501);}} protected function rewriteContextValue($_1374032640, &$_1857551742, $_30523874, $_1416308937){ if($_1374032640 === 'global'){ $_463175313= $GLOBALS['____879213633'][10]($_30523874); if(empty($_30523874)){ $GLOBALS[$_463175313]= $_1416308937;} else{ $_1857551742=& $GLOBALS[$_463175313]; ArrayHelper::setByNestedKey($_1857551742, $_30523874, $_1416308937);}} else{  ArrayHelper::setByNestedKey($_1857551742, $_30523874, $_1416308937);}} protected function unsetContextValue($_1374032640, &$_1857551742, $_30523874){ if($_1374032640 === 'global'){ $_463175313= $GLOBALS['____879213633'][11]($_30523874); if(empty($_30523874)){ unset($GLOBALS[$_463175313]);} else{ $_1857551742=& $GLOBALS[$_463175313]; ArrayHelper::unsetByNestedKey($_1857551742, $_30523874);}} else{ ArrayHelper::unsetByNestedKey($_1857551742, $_30523874);}}  protected function recursiveContextKeyHandle(string $_1374032640, array &$_1857551742, array $_39613566, Rule $_1705850340): array{  $_971661303=[]; foreach($_1857551742 as $_1154030069 => $_1416308937){ $_30523874= $GLOBALS['____879213633'][12]($_39613566,[$_1154030069]); if($_1705850340->matchKey($_30523874)){  if($_1705850340->getProcess() === ___853203826(20)){ $_1033280096= $_1705850340->evaluate($_1154030069);} elseif($_1705850340->getProcess() === ___853203826(21)){ $_1033280096= $_1705850340->evaluateValue($_1416308937);}  if(!empty($_1033280096) && $_1033280096 instanceof RuleResult){ $_971661303[]= new HandlingResult($_1374032640, $_30523874, $_1033280096, $_1705850340);}}  if($GLOBALS['____879213633'][13]($_1416308937)){ $_971661303= $GLOBALS['____879213633'][14]($_971661303, $this->recursiveContextKeyHandle( $_1374032640, $_1857551742[$_1154030069], $_30523874, $_1705850340));}} return $_971661303;} protected function getContextElements(array $_501200775){ $_1488848430=[]; if($GLOBALS['____879213633'][15](___853203826(22), $_501200775, true)){ $_1488848430[___853203826(23)]= &$_GET;} if($GLOBALS['____879213633'][16](___853203826(24), $_501200775, true)){ $_1488848430[___853203826(25)]= &$_POST;} if($GLOBALS['____879213633'][17](___853203826(26), $_501200775, true)){ $_1488848430[___853203826(27)]= &$_COOKIE;} if($GLOBALS['____879213633'][18](___853203826(28), $_501200775, true)){ $_1488848430[___853203826(29)]= &$_REQUEST;} if($GLOBALS['____879213633'][19](___853203826(30), $_501200775, true)){ $_1488848430[___853203826(31)]= $GLOBALS;} return $_1488848430;} public static function refreshRules(){ try{ $_1066315623= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____879213633'][20]()- $_1066315623)< static::CACHE_RULES_TTL){ return;} Option::set(___853203826(32), ___853203826(33), $GLOBALS['____879213633'][21]()); $_838878810= null;  $_1707461591= $GLOBALS['____879213633'][22](function($_757265023){ return[___853203826(34) => $_757265023[___853203826(35)], ___853203826(36) => (int) $_757265023[___853203826(37)]];}, ModuleManager::getModulesFromDisk());  $_1295925757=[]; foreach($GLOBALS['____879213633'][23]() as $_1646229447){ $_86141833= new ReflectionExtension($_1646229447); $_1295925757[$_1646229447]=[ ___853203826(38) => $_86141833->getVersion(), ___853203826(39) => $_86141833->getINIEntries()];} $_843228289=[ ___853203826(40) => $GLOBALS['____879213633'][24]($_1707461591), ___853203826(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___853203826(42) => $GLOBALS['____879213633'][25]([ ___853203826(43) => $GLOBALS['____879213633'][26](), ___853203826(44) => $_1295925757])]; if(Loader::includeModule(___853203826(45))){ $_376088227= CSecuritySystemInformation::getSystemInformation(); if(isset($_376088227[___853203826(46)][___853203826(47)]) && isset($_376088227[___853203826(48)][___853203826(49)])){ $_843228289[___853203826(50)]=[ ___853203826(51) => $_376088227[___853203826(52)][___853203826(53)], ___853203826(54) => $_376088227[___853203826(55)][___853203826(56)]];} if(isset($_376088227[___853203826(57)][___853203826(58)])){ $_843228289[___853203826(59)]=[___853203826(60) => $_376088227[___853203826(61)][___853203826(62)]];}}  $_963584612= new HttpClient([ ___853203826(63) => round(0+2.5+2.5), ___853203826(64) => round(0+1+1+1+1+1)]); $_1981650430= $_963584612->post( static::$_1004216642, $_843228289); if($_963584612->getStatus() == round(0+50+50+50+50) &&!empty($_1981650430)){ $_838878810= Json::decode($_1981650430);}  if($_838878810 !== null){ $_178324251= Application::getConnection(); $_1435602000= RuleRecordTable::getTableName(); if(!empty($_838878810)){ foreach($_838878810 as $_1047041758){ if(!static::checkRuleSign($_1047041758)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____879213633'][27]($_1047041758));}}}  $_178324251->truncateTable($_1435602000);  if(!empty($_838878810)){ $_307576935=[]; foreach($_838878810 as $_1047041758){ $_307576935[]= ___853203826(65). $_178324251->getSqlHelper()->forSql($_1047041758[___853203826(66)]). ___853203826(67). $_178324251->getSqlHelper()->forSql($_1047041758[___853203826(68)]). ___853203826(69). $_178324251->getSqlHelper()->forSql($_1047041758[___853203826(70)]). ___853203826(71);} $_771035245= $GLOBALS['____879213633'][28](___853203826(72), $_307576935);  $_178324251->query("INSERT INTO {$_1435602000} (DATA, MODULE, MODULE_VERSION) VALUES {$_771035245}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1807518836){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___853203826(73), ___853203826(74), ___853203826(75), ___853203826(76). $_1807518836->getMessage(). ___853203826(77). $_1807518836->getTraceAsString());}} protected static function checkRuleSign($_1705850340){ $_2115885437= new PublicKeyCipher; $_876893325= $_2115885437->decrypt($_1705850340[___853203826(78)], static::__2117506563()); return str_starts_with($_876893325, ___853203826(79));} private static function __2117506563(){ $_2095034675= ''; $_2095034675 .= ___853203826(80); $_2095034675 .= ___853203826(81); return $_2095034675;} protected function logEvent($_595930192, $_1573502644, $_895716546){ if($this->_1370633507){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_595930192, 'main', $_1573502644, $_895716546);}}}?>